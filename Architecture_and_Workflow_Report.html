<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YakTech OPN Architecture Report</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
            background: #f9f9f9;
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 0.5rem;
        }

        h2 {
            color: #34495e;
            margin-top: 2rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.3rem;
        }

        h3 {
            color: #7f8c8d;
            margin-top: 1.5rem;
        }

        code {
            background: #f0f0f0;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: monospace;
        }

        pre {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
        }

        .mermaid {
            margin: 2rem 0;
            text-align: center;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin: 1rem 0;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        .print-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            float: right;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .print-btn:hover {
            background: #2980b9;
        }

        .mode-badge {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
            margin-left: 0.5rem;
        }

        .mode-on {
            background-color: #2ecc71;
        }

        .mode-off {
            background-color: #95a5a6;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .container {
                box-shadow: none;
                padding: 0;
            }

            .print-btn {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <button onclick="window.print()" class="print-btn">üñ®Ô∏è Save as PDF</button>

        <h1>YakTech OPN Architecture Report</h1>
        <p><em>Generated by Yakkay AI Agent | Version 2.2 (Repo Rename)</em></p>

        <h2>1. System Overview</h2>
        <p>This document outlines the architecture of the YakTech Open Negotiation (OPN) Automation platform.
            As of <strong>January 2026</strong>, the system operates on a Unified Service Architecture (Repo +
            OPN-Agent).</p>

        <h2>2. High-Level Architecture</h2>
        <div class="mermaid">
            graph TD
            User["üë§ User / Browser"] -->|Chat| UI["üñ•Ô∏è Frontend UI"]
            UI -->|Process| Repo["üß† Repo (Unified Brain)"]

            subgraph Repo_Internals
            Repo <--> DB[("PostgreSQL")]
                Repo <--> Vector[("Qdrant RAG")]
                    end

                    Repo -->|Auto-Execute| OPN["‚öôÔ∏è OPN-Agent (Worker)"]
                    OPN -->|Generate| Docs["üìÑ Outputs"]

                    style UI fill:#3498db,color:#fff
                    style Repo fill:#e67e22,color:#fff
                    style OPN fill:#2ecc71,color:#fff
        </div>

        <h2>3. Routing Intelligence Modes</h2>
        <p>The Repo service operates in two distinct modes depending on configuration (`CONVERSATION_MODE`).</p>

        <h3>Mode A: Action Mode (Conversation ON) <span class="mode-badge mode-on">DEFAULT</span></h3>
        <p>This mode is interactive and safe. It validates queries, asks clarifying questions if parameters
            (Client/Wave) are missing, and requires confirmation before expensive actions.</p>

        <div class="mermaid">
            graph TD
            Start("üë§ User Query") --> Validate{"1. Is Valid?"}

            Validate -- No --> Reject["‚ùå Reject (Vague)"]
            Validate -- Yes --> Inquiry{"2. Agent Inquiry?"}

            Inquiry -- Yes --> Answer["üí¨ Answer Question"]
            Inquiry -- No --> Eval["3. Evaluate Params"]

            Eval -- "Missing Info" --> Clarify["‚ùì Ask Clarification"]
            Clarify --> UserLoop("User Responds") --> Start

            Eval -- "Ready" --> Confirm{"4. Confirm?"}

            Confirm -- "No/Unsure" --> AskConfirm["üõ°Ô∏è Ask Confirmation"]
            AskConfirm --> UserLoop

            Confirm -- "Yes" --> Route["üöÄ Execute Routing"]
            Route --> Extract["Extract JSON"]
            Extract --> Execute["‚öôÔ∏è Orchestrate OPN-Agent"]

            style Clarify fill:#f1c40f,stroke:#f39c12
            style Route fill:#2ecc71,stroke:#27ae60,color:#fff
            style Start fill:#3498db,color:#fff
        </div>

        <h3>Mode B: Direct Mode (Conversation OFF) <span class="mode-badge mode-off">LOW LATENCY</span></h3>
        <p>This mode is for "power users" or API automation. It skips validation and clarification steps, assuming the
            query is perfect.</p>

        <div class="mermaid">
            graph LR
            Start("üë§ User Query") --> Search["üîç Vector Search"]
            Search --> LLM["ü§ñ LLM Classification"]
            LLM --> Route["üöÄ Execute Routing"]
            Route --> Execute["‚öôÔ∏è Orchestrate OPN-Agent"]

            style Start fill:#95a5a6,color:#fff
            style Route fill:#2ecc71,color:#fff
        </div>

        <h2>4. Component Details</h2>
        <h3>üß† Repo Service (Port 8001)</h3>
        <ul>
            <li><strong>Intelligent Routing:</strong> Uses RAG to find the right agent.</li>
            <li><strong>Action Mode:</strong> Ensures safety via
                <br><code>Validation -> Clarification -> Confirmation -> Execution</code> loop.</li>
            <li><strong>Orchestration:</strong> Resolves file paths and triggers the Worker.</li>
        </ul>

        <h3>‚öôÔ∏è OPN-Agent (Port 8000)</h3>
        <ul>
            <li><strong>Worker Role:</strong> Pure execution engine.</li>
            <li><strong>Capabilities:</strong> Excel Grouping, Word Notices, PDF Merging.</li>
        </ul>

        <h2>5. Deployment Specs</h2>
        <table>
            <thead>
                <tr>
                    <th>Service</th>
                    <th>Port</th>
                    <th>Role</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>UI</strong></td>
                    <td>3000</td>
                    <td>Frontend</td>
                </tr>
                <tr>
                    <td><strong>Repo</strong></td>
                    <td>8001</td>
                    <td><strong>Brain (Router + API)</strong></td>
                </tr>
                <tr>
                    <td><strong>OPN-Agent</strong></td>
                    <td>8000</td>
                    <td>Worker</td>
                </tr>
            </tbody>
        </table>
    </div>

    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10.9.3/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true, theme: 'default', securityLevel: 'loose' });
    </script>
</body>

</html>